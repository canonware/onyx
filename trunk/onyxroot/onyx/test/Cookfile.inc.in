/******************************************************************************
 *
 * <Copyright = jasone>
 * <License>
 *
 ******************************************************************************
 *
 * Version: <Version>
 *
 * Top level Cookfile for tests.
 *
 ******************************************************************************/

/*
 * Targets.
 */
tests : onyx mods [addsuffix _tests bins mods libs];
check : tests [addsuffix _check bins mods libs];
check_update : tests [addsuffix _check_update bins mods libs];

tests_clean :
{
}

tests_distclean :
{
}

/*
 * Build rules for tests.
 */
[objdir]/%0test/%1 : [objdir]/%0test/%1.o_a libs_s
  set mkdir
{
  [CC] [A_CFLAGS] -o [target]
       [objdir]/%0test/%1.o_a
#if [matches elf [abi]]
       [split " "
              [prepost [prepost @RPATH@ "/lib/" [abs_objdir]]
                       "/lib"
                       @libs@]]
#endif
       [LDFLAGS] [subst lib -l [filter_out libedit @libs@]] @EXTRALIBS@;
}

[objdir]/%0test/%1.o_a : [srcdir]/%0test/%1.c
  set mkdir
{
  [CC] [A_CFLAGS] [CPPFLAGS] [CPPDEFS] -DCW_ASSERT
    -c [srcdir]/%0test/%1.c -o [target];

  c_incl [CPPFLAGS] --no-cache -Absent_Local_Ignore -No_System
         [srcdir]/%0test/%1.c
         "--prefix='"[target]" : "[srcdir]/%0test/%1.c"'"
         "--suffix='set nodefault;'"
         -o [fromto %0test/%1.o_a %0test/%1.d_a [target]];
}

/*
 * Add magic to onyx files.
 */
[objdir]/%0test/%.nx : [srcdir]/%0test/%.nx.in
  set mkdir
{
  [SHELL] -e;
data
#![SHELL]

echo \"[srcdir]/%0test/%.nx.in --> [target]\"

echo \"#![abs_objdir]/[TONYX]\" > [target]
echo \"!#\" >> [target]
cat [srcdir]/%0test/%.nx.in >> [target];
chmod u+x [target];
dataend
}
