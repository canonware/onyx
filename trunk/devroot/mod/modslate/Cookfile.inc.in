/******************************************************************************
 *
 * <Copyright = jasone>
 * <License>
 *
 ******************************************************************************
 *
 * Version: Slate <Version = slate>
 *
 * Cookfile for modslate.
 *
 ******************************************************************************/

/* Include generated dependency files. */
#include-cooked [glob @objroot@/mod/modslate/src/"*.d_*"]
#include-cooked [glob @objroot@/mod/modslate/test/"*.d_*"]

/*
 * File lists.
 */

/* Source files. */
MODSLATE_SRCS = [addprefix @srcroot@/mod/modslate/src/
                           buf.c buffer.c hist.c modslate.c
                           ];

/* Generated source code (created by configure). */
MODSLATE_NX_GEN = [fromto %.nx.in @objroot@/mod/modslate/nx/modslate/%.nx
                          modslate_defs.nx.in
                          ];

MODSLATE_NX = [addprefix @srcroot@/mod/modslate/nx/modslate/
                         modslate.nx
                         ];

MODSLATE_CTESTS = [addprefix @srcroot@/mod/modslate/test/
                             rb_a.c
                             ];

/* Modules. */
MODSLATE = @objroot@/mod/modslate/nxm/modslate.nxm;

/*
 * User cook'ables.
 */

modslate : [MODSLATE];

modslate_mods_tests : [fromto @srcroot@/%0%.c @objroot@/%0% [MODSLATE_CTESTS]];

modslate_mods_check : modslate_mods_tests
{
  @VERIFY@ -s @srcroot@ -o @objroot@
           [fromto @srcroot@/%0%.c @objroot@/%0% [MODSLATE_CTESTS]];
}

modslate_mods_check_update :
{
  @VERIFY@ -u -s @srcroot@ -o @objroot@
           [fromto @srcroot@/%0%.c @objroot@/%0% [MODSLATE_CTESTS]];
}

modslate_mods_install : [MODSLATE]
{
  @INSTALL@ -d [PREFIX]/share/slate-@slate_version@/nxm;
  @INSTALL@ -m 0444 [MODSLATE] [PREFIX]/share/slate-@slate_version@/nxm;
  @INSTALL@ -d [PREFIX]/share/slate-@slate_version@/nx/modslate;

  loop local f = [MODSLATE_NX] [MODSLATE_NX_GEN]
  {
    @INSTALL@ -m 0644 [f] [PREFIX]/share/slate-@slate_version@/nx/modslate/;
  }
}

modslate_mods_uninstall :
{
  rm -f [PREFIX]/share/slate-@slate_version@/nxm/modslate.nxm;
  rm -rf [PREFIX]/share/slate-@slate_version@/nx/modslate;
}

modslate_mods_clean :
{
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.d_s [MODSLATE_SRCS]];
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.o_s [MODSLATE_SRCS]];
  rm -f [MODSLATE];

  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.d_a [MODSLATE_CTESTS]];
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [MODSLATE_CTESTS]];
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.out [MODSLATE_CTESTS]];
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.diff [MODSLATE_CTESTS]];
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0% [MODSLATE_CTESTS]];
}

modslate_mods_distclean :
{
}

/*
 * Various flags.
 */
MODSLATE_CPPFLAGS = @MODSLATE_CPPFLAGS@;
MODSLATE_LDFLAGS = @MODSLATE_LDFLAGS@;

CPPFLAGS = [CPPFLAGS] -I@srcroot@/mod/modslate/include
                      -I@objroot@/mod/modslate/include
                      [MODSLATE_CPPFLAGS];

/*
 * Dependencies.
 */

[MODSLATE] : [fromto @srcroot@/%0%.c @objroot@/%0%.o_s [MODSLATE_SRCS]]
  set mkdir
{
  [CC]
#if [matches elf @abi@]
       -shared
#elif [matches macho @abi@]
       -undefined suppress -flat_namespace -bundle -all_load
#endif
       -o [target] [need] [MODSLATE_LDFLAGS];
}
