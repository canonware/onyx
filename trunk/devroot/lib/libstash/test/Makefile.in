# -*-mode:makefile-*-
# @configure_input@
#############################################################################
#
# Copyright (c) 1996-1998
# Jason Evans <jasone@canonware.com>.  All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer as
#    the first lines of this file unmodified.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY JASON EVANS ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL JASON EVANS BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
#############################################################################
#
# $Source$
# $Author: jasone $
# Current revision: $Revision: 7 $
# Last modified: $Date: 1998-01-16 00:20:54 -0800 (Fri, 16 Jan 1998) $
#
# Description: Makefile for ttalk regression tests.
#              
##############################################################################

#
# external variables
#

SHELL   = /bin/sh
MAKE    = @MAKE@

CC      = @CC@
PERL    = @PERL@
BASENAME = @BASENAME@
DIFF    = @DIFF@

INCS    = -I@top_srcdir@/../include
CFLAGS  = @CFLAGS@

DEFINES = -D_REENTRANT @DEFS@
STATLIB = ttalk
LIBS    = -L@top_srcdir@/../src -l$(STATLIB) @LIBS@

#
# variables
#

OBJS = $(CTESTS:=.o)
# perl programs used for the regression scripts
PMERGE   = @top_srcdir@/test/pmerge
PSTUB    = @top_srcdir@/test/pstub

# file lists
DIRS     = 
# b* : backend C code driven by the perl scripts
# c* : stand alone C tests
# p*.pl : perl scripts that drive the b* programs
CTESTS   = c19971207a
PTESTS   = 

#
# implicit rules
#

.SUFFIXES:
.SUFFIXES: .c .h .o .d .pl .pl.in 

.c.o:
	$(CC) -c $< $(CFLAGS) $(INCS) $(DEFINES)

.pl.in.pl:
	$(PERL) -w $(PMERGE) $(PERL) $(PSTUB) $< $@

#
# user 'make'ables
#

all: suball hereall FORCE

check: subcheck herecheck FORCE

install: subinstall hereinstall FORCE

uninstall: subuninstall hereuninstall FORCE

clean: subclean hereclean FORCE

distclean: subdistclean hereclean heredistclean

targets:
	@echo "User 'make'ables: all (default)"
	@echo "                  check"
	@echo "                  install"
	@echo "                  uninstall"
	@echo "                  clean"
	@echo "                  distclean"
	@echo "                  targets"

#
# internal build rules
#

FORCE:

# all
suball:
	@$(SHELL) -c 'for i in $(DIRS); do cd $$i; $(MAKE) -i all; cd -; done'

hereall:

# check
subcheck:
	@$(SHELL) -c \
	'for i in $(DIRS); do cd $$i; $(MAKE) -i check; cd -; done'

herecheck: $(CTESTS) $(PTESTS)
	@$(SHELL) -c \
	'echo Running regression tests: ; \
	for i in `find . -print |grep "\.pl$$"`; do \
	./`$(BASENAME) $$i`; \
	done; \
	for i in `find . -print | grep "^./c[A-Za-z0-9]*\.c$$"`; do \
	echo -n "`$(BASENAME) $$i .c`..."; \
	./`$(BASENAME) $$i .c` &> `$(BASENAME) $$i .c`.out; \
	$(DIFF) `$(BASENAME) $$i .c`.out `$(BASENAME) $$i .c`.expect > `$(BASENAME) $$i .c`.diff ; \
	if [ -s `$(BASENAME) $$i .c`.diff ] ; then \
	echo "failed. ****************" ; \
	else \
	echo "passed." ; \
	rm `$(BASENAME) $$i .c`.diff ; \
	fi \
	done ; \
	echo The following regression tests failed: ; \
	for i in `find . -print | grep "\.diff$$"`; do \
	echo `$(BASENAME) $$i .diff`; \
	done \
	'

# install
subinstall:
	@$(SHELL) -c \
	'for i in $(DIRS); do cd $$i; $(MAKE) -i install; cd -; done'

hereinstall:

# uninstall
subuninstall:
	@$(SHELL) -c \
	'for i in $(DIRS); do cd $$i; $(MAKE) -i uninstall; cd -; done'

hereuninstall: 

# clean
subclean:
	@$(SHELL) -c \
	'for i in $(DIRS); do cd $$i; $(MAKE) -i clean; cd -; done'

hereclean:
	rm -f *.o *~ *.d
	rm -f *.out
	rm -f *.diff
	rm -f *.bak *.BAK
	rm -f core

# distclean
subdistclean:
	@$(SHELL) -c \
	'for i in $(DIRS); do cd $$i; $(MAKE) -i distclean; cd -; done'

heredistclean:
	rm -f "#"*"#"
	rm -f $(CTESTS)
	rm -f *.pl
	rm -f Makefile

$(CTESTS): $(OBJS)
	$(CC) -o $@ $(@:=.o) $(LIBS)

#
# Rule for dependency file creation
#

%.d: %.c
	$(SHELL) -ec "$(CC) -M $(DEFINES) $(INCS) $< \
	| sed \"s/\($*\)\.o\([ :]*\)/\1.o \1.d \2/g\" > $@"

#
# Include dependencies.
#

include $(CTESTS:=.d)
