# -*-mode:makefile-*-
# @configure_input@
#############################################################################
#
# <Copyright = "jasone">
# <License>
#
#############################################################################
#
# Version: <Version>
#
# Description: Master BSD-compatible Makefile for libstash.
#              
##############################################################################

#
# File lists.
#

# Include files that _are_ installed.
INCS := libstash.h libstash_incs.h bhp.h buf.h dbg.h lex.h list.h log.h \
	matrix.h mem.h oh.h res.h treen.h

INCS_R := libstash_r.h locks.h thread.h

# Include files that are _not_ installed.
PRIV_INCS := bhp_p.h buf_p.h lex_p.h list_p.h log_p.h mem_p.h oh_p.h res_p.h

PRIV_INCS_R := locks_p.h

# Source files.
SRCS := libstash.c bhp.c buf.c dbg.c lex.c list.c log.c matrix.c mem.c oh.c \
	res.c treen.c

SRCS_R := locks.c thread.c

# Simple tests.  Output is diff'ed with the expected (.exp file) output.
CTESTS := c_buf_a.c c_cnd_a.c c_jtl_a.c c_list_a.c c_log_a.c c_matrix_a.c \
	c_mtx_a.c c_oh_a.c c_oh_b.c c_oh_c.c c_res_a.c c_rwl_a.c c_sem_a.c \
	c_thd_a.c c_treen_a.c

# Hopelessly broken.
# c_bhp_a.c 

# Perl scripts that drive the BTESTS.
PTESTS := p19980828a.pl.in

# Backend test programs that are driven by the PTESTS.
BTESTS := b19980828a.c

# Munge the filename lists so that they are prefixed by the directory they're
# in, relative to @top_srcdir@.  Also, convert the test names to their final
# names.
INCS := $(INCS:S/^/$(.CURDIR)\/include\/libstash\/&/)
INCS_R := $(INCS_R:S/^/$(.CURDIR)\/include\/libstash\/&/)
PRIV_INCS := $(PRIV_INCS:S/^/$(.CURDIR)\/include\/libstash\/&/)
PRIV_INCS_R := $(PRIV_INCS_R:S/^/$(.CURDIR)\/include\/libstash\/&/)

SRCS := $(SRCS:S/^/$(.CURDIR)\/src\/&/)
SRCS_R := $(SRCS_R:S/^/$(.CURDIR)\/src\/&/)

CTESTS := $(CTESTS:R:S/^/$(.CURDIR)\/test\/&/)
BTESTS := $(BTESTS:R:S/^/$(.CURDIR)\/test\/&/)
PTESTS := $(PTESTS:R:S/^/$(.CURDIR)\/test\/&/)

#
# Library names.
#

LIB := stash

LIB_REV := 0.0

LIB_ST_D := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&_d.a/)
LIB_ST_O := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&.a/)
LIB_SH_O := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&.so.$(LIB_REV)/)
LIB_ST_P := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&_p.a/)
LIB_ST_R_D := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&_r_d.a/)
LIB_ST_R_O := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&_r.a/)
LIB_SH_R_O := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&_r.so.$(LIB_REV)/)
LIB_ST_R_P := $(LIB:S/^/$(.CURDIR)\/lib\/lib&/:S/$/&_r_p.a/)

#
# Standard definitions.
#

SHELL   := /bin/sh
CC	:= @CC@
AR	:= @AR@
RANLIB	:= @RANLIB@
INSTALL	:= @INSTALL@
CAT     := @CAT@
PERL    := @PERL@
BASENAME:= @BASENAME@
DIFF    := @DIFF@
PMERGE  := $(.CURDIR)/bin/pmerge
PSTUB   := $(.CURDIR)/bin/pstub

#
# Compiler flags.
#

LIBPATH := -L$(.CURDIR)/lib
EXTRALIBS := @LDFLAGS@ @LIBS@
INCPATH := -I$(.CURDIR)/include @CPPFLAGS@

DEFINES := @DEFS@
ST_DEFINES := 
SH_DEFINES := 
D_DEFINES := -D_LIBSTASH_DBG
O_DEFINES := 
P_DEFINES := 
R_DEFINES := -D_CW_REENTRANT
TEST_DEFINES := -D_LIBSTASH_DEBUG

CFLAGS := -Wall -pipe @CFLAGS@
ST_CFLAGS := 
SH_CFLAGS := -fPIC -DPIC
D_CFLAGS := -g3
O_CFLAGS := -O3
P_CFLAGS := -O3 -pg
R_CFLAGS :=

# Clear out all vpaths, then set just one (default vpath) for the main build
# directory.
.PATH :
.PATH : .

# Need this here since the includes have dependencies in them, but there's
# stuff in the includes that we need to see before using $(TARGETS).
all : all_s @without_threads@all_r

#
# Common rules
#
.SUFFIXES :
.SUFFIXES : .a .c .h .o .d .pl.in .pl \
	.o_st_d .o_st_o .o_sh_o .o_st_p \
	.o_st_r_d .o_st_r_o .o_sh_r_o .o_st_r_p \
	.d_st_d .d_st_o .d_sh_o .d_st_p \
	.d_st_r_d .d_st_r_o .d_sh_r_o .d_st_r_p

#
# Build rules.
#

# This rule is used to build the tests.
.for bin in $(CTESTS) $(BTESTS)
$(bin) : $(LIB_ST_R_D) $(bin:S/$/&.c/)
	$(CC) $(CFLAGS) $(ST_CFLAGS) $(D_CFLAGS) $(R_CFLAGS) $(INCPATH) $(DEFINES) $(R_DEFINES) $(TEST_DEFINES) -c $(bin:S/$/&.c/) -o $(@:S/$/&.o/)
	$(CC) -o $@ $(@:S/$/&.o/) $(LIB_ST_R_D) $(LIBPATH) -dynamic $(EXTRALIBS)
	$(SHELL) -ec "$(CC) -M $(DEFINES) $(ST_DEFINES) $(D_DEFINES) $(INCPATH) $(bin:S/$/&.c/) | sed \"s/\($(bin:R:T)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/test\/\1.o \2/g\" > $(@:R:S/$/&.d/)"
.endfor

.for srcfile in $(SRCS)
$(srcfile:T:R:S/^/$(.OBJDIR)\/st_d\/&/:S/$/&.o_st_d/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(ST_CFLAGS) $(D_CFLAGS) $(DEFINES) $(ST_DEFINES) $(D_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(ST_DEFINES) $(D_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/st_d\/\1.o_st_d \2/g\" > $(@:R:S/$/&.d_st_d/)"

$(srcfile:T:R:S/^/$(.OBJDIR)\/st_o\/&/:S/$/&.o_st_o/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(ST_CFLAGS) $(O_CFLAGS) $(DEFINES) $(ST_DEFINES) $(O_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(ST_DEFINES) $(O_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/st_o\/\1.o_st_o \2/g\" > $(@:R:S/$/&.d_st_o/)"

$(srcfile:T:R:S/^/$(.OBJDIR)\/sh_o\/&/:S/$/&.o_sh_o/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(SH_CFLAGS) $(O_CFLAGS) $(DEFINES) $(SH_DEFINES) $(O_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(SH_DEFINES) $(O_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/sh_o\/\1.o_sh_o \2/g\" > $(@:R:S/$/&.d_sh_o/)"

$(srcfile:T:R:S/^/$(.OBJDIR)\/st_p\/&/:S/$/&.o_st_p/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(ST_CFLAGS) $(P_CFLAGS) $(DEFINES) $(ST_DEFINES) $(P_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(ST_DEFINES) $(P_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/st_p\/\1.o_st_p \2/g\" > $(@:R:S/$/&.d_st_p/)"
.endfor

.for srcfile in $(SRCS) $(SRCS_R)
$(srcfile:T:R:S/^/$(.OBJDIR)\/st_r_d\/&/:S/$/&.o_st_r_d/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(ST_CFLAGS) $(D_CFLAGS) $(R_CFLAGS) $(DEFINES) $(ST_DEFINES) $(D_DEFINES) $(R_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(ST_DEFINES) $(D_DEFINES) $(R_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/st_r_d\/\1.o_st_r_d \2/g\" > $(@:R:S/$/&.d_st_r_d/)"

$(srcfile:T:R:S/^/$(.OBJDIR)\/st_r_o\/&/:S/$/&.o_st_r_o/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(ST_CFLAGS) $(O_CFLAGS) $(R_CFLAGS) $(DEFINES) $(ST_DEFINES) $(O_DEFINES) $(R_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(ST_DEFINES) $(O_DEFINES) $(R_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/st_r_o\/\1.o_st_r_o \2/g\" > $(@:R:S/$/&.d_st_r_o/)"

$(srcfile:T:R:S/^/$(.OBJDIR)\/sh_r_o\/&/:S/$/&.o_sh_r_o/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(SH_CFLAGS) $(O_CFLAGS) $(R_CFLAGS) $(DEFINES) $(SH_DEFINES) $(O_DEFINES) $(R_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(SH_DEFINES) $(O_DEFINES) $(R_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/sh_r_o\/\1.o_sh_r_o \2/g\" > $(@:R:S/$/&.d_sh_r_o/)"

$(srcfile:T:R:S/^/$(.OBJDIR)\/st_r_p\/&/:S/$/&.o_st_r_p/) : $(srcfile)
	$(CC) $(INCPATH) $(CFLAGS) $(ST_CFLAGS) $(P_CFLAGS) $(R_CFLAGS) $(DEFINES) $(ST_DEFINES) $(P_DEFINES) $(R_DEFINES) -c $(srcfile) -o $@
	$(SHELL) -ec "$(CC) -MM $(DEFINES) $(ST_DEFINES) $(P_DEFINES) $(R_DEFINES) $(INCPATH) $(srcfile) | sed \"s/\($(srcfile:T:R)\)\.o\([ :]*\)/$(.CURDIR:S/\//\\\//g)\/obj\/st_r_p\/\1.o_st_r_p \2/g\" > $(@:R:S/$/&.d_st_r_p/)"
.endfor

.pl.in.pl :
	$(PERL) -w $(PMERGE) $(PERL) $(PSTUB) $< $@

#
# Dependencies (not rules).
#

.for depfile in $(SRCS:T:R:S/^/$(.CURDIR)\/obj\/st_d\/&/:S/$/&.d_st_d/) \
	$(SRCS:T:R:S/^/$(.CURDIR)\/obj\/st_o\/&/:S/$/&.d_st_o/) \
	$(SRCS:T:R:S/^/$(.CURDIR)\/obj\/sh_o\/&/:S/$/&.d_sh_o/) \
	$(SRCS:T:R:S/^/$(.CURDIR)\/obj\/st_p\/&/:S/$/&.d_st_p/)
.if exists($(depfile))
.include "$(depfile)"
.endif
.endfor

#@without_threads@WITH_THREADS=yes
#.ifdef WITHTHREADS
@without_threads@.for depfile in $(SRCS:T:R:S/^/$(.CURDIR)\/obj\/st_r_d\/&/:S/$/&.d_st_r_d/) \
@without_threads@	$(SRCS_R:T:R:S/^/$(.CURDIR)\/obj\/st_r_d\/&/:S/$/&.d_st_r_d/) \
@without_threads@	$(SRCS:T:R:S/^/$(.CURDIR)\/obj\/st_r_o\/&/:S/$/&.d_st_r_o/) \
@without_threads@	$(SRCS_R:T:R:S/^/$(.CURDIR)\/obj\/st_r_o\/&/:S/$/&.d_st_r_o/) \
@without_threads@	$(SRCS:T:R:S/^/$(.CURDIR)\/obj\/sh_r_o\/&/:S/$/&.d_sh_r_o/) \
@without_threads@	$(SRCS_R:T:R:S/^/$(.CURDIR)\/obj\/sh_r_o\/&/:S/$/&.d_sh_r_o/) \
@without_threads@	$(SRCS:T:R:S/^/$(.CURDIR)\/obj\/st_r_p\/&/:S/$/&.d_st_r_p/) \
@without_threads@	$(SRCS_R:T:R:S/^/$(.CURDIR)\/obj\/st_r_p\/&/:S/$/&.d_st_p_d/)
@without_threads@.if exists($(depfile))
@without_threads@.include "$(depfile)"
@without_threads@.endif
@without_threads@.endfor
#.endif

.for depfile in $(CTESTS:R:S/$/&.d/) $(BTESTS:R:S/$/&.d/)
.if exists($(depfile))
.include "$(depfile)"
.endif
.endfor

$(LIB_ST_D) : $(SRCS:T:R:S/^/$(.OBJDIR)\/st_d\/&/:S/$/&.o_st_d/)
	$(AR) cru $@ $?
	$(RANLIB) $@

$(LIB_ST_O) : $(SRCS:T:R:S/^/$(.OBJDIR)\/st_o\/&/:S/$/&.o_st_o/)
	$(AR) cru $@ $?
	$(RANLIB) $@

$(LIB_SH_O) : $(SRCS:T:R:S/^/$(.OBJDIR)\/sh_o\/&/:S/$/&.o_sh_o/)
	$(CC) -shared -o $@ $>

$(LIB_ST_P) : $(SRCS:T:R:S/^/$(.OBJDIR)\/st_p\/&/:S/$/&.o_st_p/)
	$(AR) cru $@ $?
	$(RANLIB) $@

$(LIB_ST_R_D) : $(SRCS:T:R:S/^/$(.OBJDIR)\/st_r_d\/&/:S/$/&.o_st_r_d/) \
	$(SRCS_R:T:R:S/^/$(.OBJDIR)\/st_r_d\/&/:S/$/&.o_st_r_d/)
	$(AR) cru $@ $?
	$(RANLIB) $@

$(LIB_ST_R_O) : $(SRCS:T:R:S/^/$(.OBJDIR)\/st_r_o\/&/:S/$/&.o_st_r_o/) \
	$(SRCS_R:T:R:S/^/$(.OBJDIR)\/st_r_o\/&/:S/$/&.o_st_r_o/)
	$(AR) cru $@ $?
	$(RANLIB) $@

$(LIB_SH_R_O) : $(SRCS:T:R:S/^/$(.OBJDIR)\/sh_r_o\/&/:S/$/&.o_sh_r_o/) \
	$(SRCS_R:T:R:S/^/$(.OBJDIR)\/sh_r_o\/&/:S/$/&.o_sh_r_o/)
	$(CC) -shared -o $@ $>

$(LIB_ST_R_P) : $(SRCS:T:R:S/^/$(.OBJDIR)\/st_r_p\/&/:S/$/&.o_st_r_p/) \
	$(SRCS:T:R:S/^/$(.OBJDIR)\/st_r_p\/&/:S/$/&.o_st_r_p/)
	$(AR) cru $@ $?
	$(RANLIB) $@

stat_dbg : $(LIB_ST_D) makefile
stat_opt : $(LIB_ST_O) makefile
shar_opt : $(LIB_SH_O) makefile
stat_prof : $(LIB_ST_P) makefile
stat_dbg_r : $(LIB_ST_R_D) makefile
stat_opt_r : $(LIB_ST_R_O) makefile
shar_opt_r : $(LIB_SH_R_O) makefile
stat_prof_r : $(LIB_ST_R_P) makefile

#
# autoconf-related rules.
#
$(.CURDIR)/configure : $(.CURDIR)/configure.in
	$(SHELL) -c 'cd $(.CURDIR); autoconf; cd -'

$(.CURDIR)/config.status : $(.CURDIR)/configure
	$(SHELL) -c 'cd $(.CURDIR); ./config.status --recheck; cd -'

makefile :: $(.CURDIR)/Makefile

$(.CURDIR)/Makefile : $(.CURDIR)/Makefile.bsd
$(.CURDIR)/Makefile.bsd : $(.CURDIR)/Makefile.bsd.in $(.CURDIR)/config.status
	$(SHELL) -c 'cd $(.CURDIR); ./config.status; cd -'

$(.CURDIR)/stamp.in : $(.CURDIR)/configure.in
	$(SHELL) -c 'cd $(.CURDIR); echo timestamp > stamp.in; cd -'

$(.CURDIR)/stamp : $(.CURDIR)/include/libstash/libstash.h.in \
	$(.CURDIR)/config.status
	$(SHELL) -c 'cd $(.CURDIR); ./config.status; cd -'

$(.CURDIR)/include/libstash/libstash.h : $(.CURDIR)/stamp

FORCE :

#
# user 'make'ables
#

all_s : stat_dbg stat_opt shar_opt stat_prof

all_r : stat_dbg_r stat_opt_r shar_opt_r stat_prof_r

tests : $(CTESTS) $(PTESTS) $(BTESTS) makefile

check : tests
	@$(SHELL) -c \
	'cd $(.CURDIR) \
	echo Running regression tests: ; \
	echo "---------------------------------------------" ;\
	for i in $(PTESTS); do \
	echo -n "$$i..."; \
	$$i; \
	done; \
	for i in $(CTESTS); do \
	echo -n "$$i..."; \
	$$i > $$i.out 2>&1; \
	$(DIFF) $$i.out $$i.exp > $$i.diff ; \
	if [ -s $$i.diff ] ; then \
	echo "failed. ****************" ; \
	else \
	echo "passed." ; \
	rm $$i.diff ; \
	fi \
	done ; \
	echo "---------------------------------------------" ;\
	echo ;\
	echo The following regression tests failed: ; \
	echo "---------------------------------------------" ;\
	for i in `find ./test -print | grep "\.diff$$"`; do \
	echo `echo $$i | sed "s/\.\/\(.*\)\.diff/\1/g"`; \
	done; \
	echo "---------------------------------------------" \
	cd - \
	'

install : install_s @without_threads@install_r

install_s : install_stat_dbg install_stat_opt install_shar_opt \
	install_stat_prof

install_r : install_stat_dbg_r install_stat_opt_r install_shar_opt_r \
	install_stat_prof_r

install_common : makefile
	$(SHELL) -c \
	'@INSTALL@ -d @prefix@/include/libstash; \
	@INSTALL@ -d @prefix@/include/libstash; \
	for i in $(INCS); do \
	@INSTALL@ -m 0644 $$i @prefix@/include/libstash/; \
	@INSTALL@ -d @prefix@/lib; \
	done; \
	'

install_common_r : install_common
	$(SHELL) -c \
	'for i in $(INCS_R); do \
	@INSTALL@ -m 0644 $$i @prefix@/include/libstash/; \
	done; \
	'

install_stat_dbg : stat_dbg install_common
	@INSTALL@ -m 0444 $(LIB_ST_D) @prefix@/lib

install_stat_opt : stat_opt install_common
	@INSTALL@ -m 0444 $(LIB_ST_O) @prefix@/lib

install_shar_opt : shar_opt install_common
	@INSTALL@ -m 0444 $(LIB_SH_O) @prefix@/lib

install_stat_prof : stat_prof install_common
	@INSTALL@ -m 0444 $(LIB_ST_P) @prefix@/lib

install_stat_dbg_r : stat_dbg_r install_common install_common_r
	@INSTALL@ -m 0444 $(LIB_ST_R_D) @prefix@/lib

install_stat_opt_r : stat_opt_r install_common install_common_r
	@INSTALL@ -m 0444 $(LIB_ST_R_O) @prefix@/lib

install_shar_opt_r : shar_opt_r install_common install_common_r
	@INSTALL@ -m 0444 $(LIB_SH_R_O) @prefix@/lib

install_stat_prof_r : stat_prof_r install_common install_common_r
	@INSTALL@ -m 0444 $(LIB_ST_R_P) @prefix@/lib

uninstall : makefile
	rm -f @prefix@/lib/lib$(LIB)*
	rm -rf @prefix@/include/libstash

doc :

clean : makefile FORCE
	rm -f $(.CURDIR)/*~ $(.CURDIR)/*/*~
	rm -f $(.CURDIR)/*.bak $(.CURDIR)/*.BAK
	rm -f $(.CURDIR)/core $(.CURDIR)/test/core
	rm -f $(.CURDIR)/*.core $(.CURDIR)/test/*.core
	rm -f $(.CURDIR)/test/*.o $(.CURDIR)/test/*.out
	rm -f $(.CURDIR)/test/*.diff $(.CURDIR)/test/*.pl
	rm -f $(CTESTS) $(PTESTS) $(BTESTS)
	rm -f $(.CURDIR)/obj/*/*.[do]*
	rm -f $(.CURDIR)/lib/lib*
	rm -f $(.CURDIR)/test/*.d
	rm -f $(.CURDIR)/test/*.diff

distclean : clean
	rm -f $(.CURDIR)/"#"*"#" $(.CURDIR)/bin/"#"*"#"
	rm -f $(.CURDIR)/src/"#"*"#" $(.CURDIR)/include/"#"*"#"
	rm -f $(.CURDIR)/Makefile $(.CURDIR)/Makefile.bsd 
	rm -f $(.CURDIR)/Makefile.gnu $(.CURDIR)/stamp
	rm -f $(.CURDIR)/config.cache $(.CURDIR)/config.log 
	rm -f $(.CURDIR)/config.status $(.CURDIR)/include/libstash/libstash.h
	rm -f $(.CURDIR)/TAGS
	rm -f $(.CURDIR)/$(PMERGE)
	rm -f $(.CURDIR)/$(PSTUB)

etags : $(INCS) $(INCS_R) $(PRIV_INCS) $(PRIV_INCS_R) $(SRCS) $(SRCS_R) \
	makefile
	@ETAGS@ $(INCS) $(INCS_R) $(PRIV_INCS) $(PRIV_INCS_R) $(SRCS) $(SRCS_R)
