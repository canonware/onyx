/******************************************************************************
 *
 * <Copyright = jasone>
 * <License>
 *
 ******************************************************************************
 *
 * Version: Onyx <Version = onyx>
 *
 * Cookfile for onyx.
 *
 ******************************************************************************/

/* Include generated dependency files. */
#include-cooked [glob @objroot@/bin/onyx/src/"*.d_*"]

/*
 * File lists.
 */

TONYX_SRCS = tonyx.c;
TONYX_SRCS = [addprefix @srcroot@/bin/onyx/src/ [TONYX_SRCS]];

/* Source files common to onyx and bonyx. */
ONYX_COMMON_SRCS = [addprefix @srcroot@/bin/onyx/src/
                              onyx.c
                              ];

/* Onyx source files that are used to generate C code. */
ONYX_NSRCS = [addprefix @srcroot@/bin/onyx/src/
                        batch.nx.in interactive.nx.in
                        ];

/* bonyx-only source files. */
BONYX_ONLY_SRCS = [fromto %0%.nx.in %0%_bootstrap.c [ONYX_NSRCS]];

/* onyx-only source files. */
ONYX_ONLY_SRCS = [fromto @srcroot@/%0%.nx.in @objroot@/%0%_nxcode.c
                         [ONYX_NSRCS]];

/*
 * Onyx tests.
 */
ONYX_OTESTS =
#if [and @enable_threads@ @enable_posix@]

              name_unsweep.nx.in setgstderr_a.nx.in setgstderr_b.nx.in
              setgstderr_c.nx.in setgstdin_a.nx.in setgstdin_b.nx.in
              setgstdin_c.nx.in setgstdout_a.nx.in setgstdout_b.nx.in
              setgstdout_c.nx.in

#endif
#if @enable_threads@

              gc_roll.nx.in gstderr_a.nx.in gstdin_a.nx.in gstdout_a.nx.in
              monitor_a.nx.in monitor_b.nx.in monitor_c.nx.in

#endif
#if @enable_real@

              abs_d.nx.in add_e.nx.in atan_a.nx.in atan_b.nx.in atan_c.nx.in
              atan_d.nx.in ceiling_a.nx.in ceiling_b.nx.in ceiling_c.nx.in
              cos_a.nx.in cos_b.nx.in cos_c.nx.in cvds_a.nx.in cvds_b.nx.in
              cvds_c.nx.in cvds_d.nx.in cves_a.nx.in cves_b.nx.in cves_c.nx.in
              cves_d.nx.in cvs_c.nx.in div_a.nx.in div_b.nx.in div_c.nx.in
              div_d.nx.in div_e.nx.in eq_c.nx.in exp_e.nx.in floor_a.nx.in
              floor_b.nx.in floor_c.nx.in ge_i.nx.in gt_i.nx.in le_i.nx.in
              ln_a.nx.in ln_b.nx.in ln_c.nx.in ln_d.nx.in log_a.nx.in
              log_b.nx.in log_c.nx.in log_d.nx.in lt_i.nx.in mul_e.nx.in
              ne_c.nx.in neg_d.nx.in output_b.nx.in round_a.nx.in round_b.nx.in
              round_c.nx.in sin_a.nx.in sin_b.nx.in sin_c.nx.in sprint_b.nx.in
              sqrt_a.nx.in sqrt_b.nx.in sqrt_c.nx.in sqrt_d.nx.in sub_e.nx.in
              trunc_a.nx.in trunc_b.nx.in trunc_c.nx.in

#endif
#if @enable_posix@

              argv_a.nx.in argv_b.nx.in dirforeach_a.nx.in dirforeach_b.nx.in
              dirforeach_c.nx.in nsleep_a.nx.in nsleep_b.nx.in nsleep_c.nx.in
              nsleep_d.nx.in poll_a.nx.in poll_b.nx.in poll_c.nx.in poll_d.nx.in
              poll_e.nx.in poll_f.nx.in poll_g.nx.in poll_h.nx.in poll_i.nx.in
              poll_j.nx.in rand_a.nx.in setenv_a.nx.in setenv_b.nx.in
              setenv_c.nx.in srand_a.nx.in srand_b.nx.in srand_c.nx.in
              srand_d.nx.in unsetenv_a.nx.in unsetenv_b.nx.in truncate_a.nx.in
              truncate_b.nx.in truncate_c.nx.in truncate_d.nx.in
              truncate_e.nx.in

#endif

              abs_a.nx.in abs_b.nx.in abs_c.nx.in add_a.nx.in add_b.nx.in
              add_c.nx.in add_d.nx.in and_a.nx.in and_b.nx.in and_c.nx.in
              and_d.nx.in and_e.nx.in and_f.nx.in bdup_a.nx.in bdup_b.nx.in
              begin_a.nx.in begin_b.nx.in begin_c.nx.in bind_a.nx.in
              bpop_a.nx.in bpop_b.nx.in bpush_a.nx.in bpush_b.nx.in cat_a.nx.in
              cat_b.nx.in cat_c.nx.in cat_d.nx.in clear_a.nx.in
              cleardstack_a.nx.in cleartomark_a.nx.in copy_a.nx.in copy_b.nx.in
              copy_c.nx.in copy_d.nx.in copy_e.nx.in copy_f.nx.in copy_g.nx.in
              count_a.nx.in countdstack_a.nx.in countestack_a.nx.in
              counttomark_a.nx.in counttomark_b.nx.in counttomark_c.nx.in
              cve_a.nx.in cve_b.nx.in cvlit_a.nx.in cvlit_b.nx.in cvn_a.nx.in
              cvn_b.nx.in cvn_c.nx.in cvrs_a.nx.in cvrs_b.nx.in cvrs_c.nx.in
              cvrs_d.nx.in cvrs_e.nx.in cvrs_f.nx.in cvs_a.nx.in cvs_b.nx.in
              cvx_a.nx.in cvx_b.nx.in def_a.nx.in def_b.nx.in dict_a.nx.in
              dn_a.nx.in dn_b.nx.in dstack_a.nx.in dup_a.nx.in dup_b.nx.in
              end_a.nx.in end_b.nx.in eq_a.nx.in eq_b.nx.in eval.nx.in
              eval_a.nx.in eval_b.nx.in exch_a.nx.in exch_b.nx.in exch_c.nx.in
              exit_a.nx.in exp_a.nx.in exp_b.nx.in exp_c.nx.in exp_d.nx.in
              for_a.nx.in for_b.nx.in for_c.nx.in for_d.nx.in for_e.nx.in
              foreach_a.nx.in foreach_b.nx.in foreach_c.nx.in ge_a.nx.in
              ge_b.nx.in ge_c.nx.in ge_d.nx.in ge_e.nx.in ge_f.nx.in ge_g.nx.in
              ge_h.nx.in get_a.nx.in get_b.nx.in get_c.nx.in get_d.nx.in
              get_e.nx.in get_f.nx.in get_g.nx.in get_h.nx.in
              getinterval_a.nx.in getinterval_b.nx.in getinterval_c.nx.in
              getinterval_d.nx.in getinterval_e.nx.in getinterval_f.nx.in
              getinterval_g.nx.in getinterval_h.nx.in getinterval_i.nx.in
              gt_a.nx.in gt_b.nx.in gt_c.nx.in gt_d.nx.in gt_e.nx.in gt_f.nx.in
              gt_g.nx.in gt_h.nx.in hello.nx.in ibdup_a.nx.in ibdup_b.nx.in
              ibdup_c.nx.in ibdup_d.nx.in ibdup_e.nx.in ibdup_f.nx.in
              ibpop_a.nx.in ibpop_b.nx.in ibpop_c.nx.in ibpop_d.nx.in
              ibpop_e.nx.in ibpop_f.nx.in idiv_a.nx.in idiv_b.nx.in idiv_c.nx.in
              idiv_d.nx.in idiv_e.nx.in idup_a.nx.in idup_b.nx.in idup_c.nx.in
              idup_d.nx.in idup_e.nx.in idup_f.nx.in if_a.nx.in if_b.nx.in
              if_c.nx.in ifelse_a.nx.in ifelse_b.nx.in ifelse_c.nx.in
              immediate_a.nx.in immediate_b.nx.in integer.nx.in integer_a.nx.in
              integer_b.nx.in integer_c.nx.in integer_d.nx.in ipop_a.nx.in
              ipop_b.nx.in ipop_c.nx.in ipop_d.nx.in ipop_e.nx.in known_a.nx.in
              known_b.nx.in known_c.nx.in le_a.nx.in le_b.nx.in le_c.nx.in
              le_d.nx.in le_e.nx.in le_f.nx.in le_g.nx.in le_h.nx.in
              length_a.nx.in length_b.nx.in length_c.nx.in loop_a.nx.in
              loop_b.nx.in lt_a.nx.in lt_b.nx.in lt_c.nx.in lt_d.nx.in
              lt_e.nx.in lt_f.nx.in lt_g.nx.in lt_h.nx.in mark_a.nx.in
              mod_a.nx.in mod_b.nx.in mod_c.nx.in mod_d.nx.in mod_e.nx.in
              mul_a.nx.in mul_b.nx.in mul_c.nx.in mul_d.nx.in nbpop_a.nx.in
              nbpop_b.nx.in nbpop_c.nx.in nbpop_d.nx.in nbpop_e.nx.in
              ndn_a.nx.in ndn_b.nx.in ndn_c.nx.in ndn_d.nx.in ndn_e.nx.in
              ndn_f.nx.in ndup_a.nx.in ndup_b.nx.in ndup_c.nx.in ndup_d.nx.in
              ndup_e.nx.in ne_a.nx.in ne_b.nx.in neg_a.nx.in neg_b.nx.in
              neg_c.nx.in nip_a.nx.in nip_b.nx.in not_a.nx.in not_b.nx.in
              not_c.nx.in npop_a.nx.in npop_b.nx.in npop_c.nx.in npop_d.nx.in
              npop_e.nx.in nup_a.nx.in nup_b.nx.in nup_c.nx.in nup_d.nx.in
              nup_e.nx.in nup_f.nx.in or_a.nx.in or_b.nx.in or_c.nx.in
              or_d.nx.in or_e.nx.in or_f.nx.in output_a.nx.in pop_a.nx.in
              pop_b.nx.in put_a.nx.in put_b.nx.in put_c.nx.in put_d.nx.in
              put_e.nx.in put_f.nx.in put_g.nx.in put_h.nx.in
              putinterval_a.nx.in putinterval_b.nx.in putinterval_c.nx.in
              putinterval_d.nx.in putinterval_e.nx.in putinterval_f.nx.in
              putinterval_g.nx.in putinterval_h.nx.in putinterval_i.nx.in
              repeat_a.nx.in repeat_b.nx.in repeat_c.nx.in repeat_d.nx.in
              roll_a.nx.in roll_b.nx.in roll_c.nx.in roll_d.nx.in roll_e.nx.in
              roll_f.nx.in roll_g.nx.in sclear_a.nx.in sclear_b.nx.in
              sclear_c.nx.in scleartomark_a.nx.in scleartomark_b.nx.in
              scleartomark_c.nx.in scleartomark_d.nx.in scount_a.nx.in
              scount_b.nx.in scount_c.nx.in scounttomark_a.nx.in
              scounttomark_b.nx.in scounttomark_c.nx.in sdup_a.nx.in
              sdup_b.nx.in sdup_c.nx.in sdup_d.nx.in search.nx.in
              setstderr_a.nx.in setstderr_b.nx.in setstderr_c.nx.in
              setstdin_a.nx.in setstdin_b.nx.in setstdin_c.nx.in
              setstdout_a.nx.in setstdout_b.nx.in setstdout_c.nx.in
              sexch_a.nx.in sexch_b.nx.in sexch_c.nx.in sexch_d.nx.in
              shift_a.nx.in shift_b.nx.in shift_c.nx.in shift_d.nx.in
              sidup_a.nx.in sidup_b.nx.in sidup_c.nx.in sidup_d.nx.in
              sidup_e.nx.in sidup_f.nx.in sidup_g.nx.in spop_a.nx.in
              spop_b.nx.in spop_c.nx.in spop_d.nx.in sprint_a.nx.in
              spush_a.nx.in spush_b.nx.in spush_c.nx.in spush_d.nx.in
              sroll_a.nx.in sroll_b.nx.in sroll_c.nx.in sroll_d.nx.in
              sroll_e.nx.in sroll_f.nx.in sroll_g.nx.in sroll_h.nx.in
              sroll_i.nx.in stack_a.nx.in start_a.nx.in start_b.nx.in
              stderr_a.nx.in stdin_a.nx.in stdout_a.nx.in stopped_a.nx.in
              stopped_b.nx.in stopped_c.nx.in string_a.nx.in string_b.nx.in
              string_c.nx.in string_d.nx.in sub_a.nx.in sub_b.nx.in sub_c.nx.in
              sub_d.nx.in sym_lp_a.nx.in sym_gt_a.nx.in sym_gt_b.nx.in
              sym_gt_c.nx.in sym_lt_a.nx.in sym_rp_a.nx.in sym_rp_b.nx.in
              syntaxerror_a.nx.in syntaxerror_b.nx.in syntaxerror_c.nx.in
              syntaxerror_d.nx.in syntaxerror_e.nx.in syntaxerror_f.nx.in
              syntaxerror_g.nx.in syntaxerror_h.nx.in syntaxerror_i.nx.in
              syntaxerror_j.nx.in syntaxerror_k.nx.in throw_a.nx.in
              throw_b.nx.in throw_c.nx.in token_a.nx.in token_b.nx.in
              token_c.nx.in tuck_a.nx.in tuck_b.nx.in tuck_c.nx.in type_a.nx.in
              type_b.nx.in undef_a.nx.in undef_b.nx.in undef_c.nx.in up_a.nx.in
              up_b.nx.in where_a.nx.in where_b.nx.in xcheck_a.nx.in
              xcheck_b.nx.in xor_a.nx.in xor_b.nx.in xor_c.nx.in xor_d.nx.in
              xor_e.nx.in xor_f.nx.in

              ;

ONYX_OTESTS = [addprefix @srcroot@/bin/onyx/test/ [ONYX_OTESTS]];

/*
 * Back end scripts driven by Onyx tests.
 */
ONYX_BTESTS = [addprefix @srcroot@/bin/onyx/test/
#if @enable_posix@
                         b_argv_b.nx.in
#endif
                         ];

/* LaTeX source files. */
ONYX_TEX_SRCS += @objroot@/bin/onyx/doc/latex/manual.tex;

/* Binaries. */
ONYX = @objroot@/bin/onyx/bin/onyx;
BONYX = @objroot@/bin/onyx/bin/bonyx;
TONYX = @objroot@/bin/onyx/bin/tonyx;

[TONYX] : [ONYX];

/*
 * User cook'ables.
 */

tonyx : [TONYX];
bonyx : [BONYX];
onyx : [ONYX];

onyx_bins_bootstrap : [BONYX]
{
  loop local f = [fromto @srcroot@/bin/onyx/src/%.nx.in % [ONYX_NSRCS]]
  {
    cat @objroot@/bin/onyx/src/[f].nx
      | [BONYX] @srcroot@/bin/onyx/src/[f]_gen.nx
      > @srcroot@/bin/onyx/src/[f]_bootstrap.c;
  }
}

onyx_bins_tests : [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx
                          [ONYX_OTESTS] [ONYX_BTESTS]];

onyx_bins_check : onyx_bins_tests [TONYX]
{
#if [count [ONYX_OTESTS]]
  @VERIFY@ -s @srcroot@ -o @objroot@
           [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx [ONYX_OTESTS]];
#endif
}

onyx_bins_check_update : onyx_bins_tests [TONYX]
{
#if [count [ONYX_OTESTS]]
  @VERIFY@ -u -s @srcroot@ -o @objroot@
           [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx [ONYX_OTESTS]];
#endif
}

onyx_bins_install : [ONYX] mods_install
#if @enable_libonyx@
               libonyx_libs_install_s
#endif
{
  @INSTALL@ -d [PREFIX]/bin;

  [CC] [A_CFLAGS] -o [PREFIX]/bin/onyx-@onyx_version@
       [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [ONYX_COMMON_SRCS]]
       [fromto %0%.c %0%.o_a [ONYX_ONLY_SRCS]]
#if @enable_libonyx@
#if [count @RPATH@]
       @RPATH@[PREFIX]/lib
#endif
#endif
       [LDFLAGS] -lonyx @LIBS@;
  chmod 0755 [PREFIX]/bin/onyx-@onyx_version@;
  rm -f [PREFIX]/bin/onyx;
  ln -s onyx-@onyx_version@ [PREFIX]/bin/onyx;

  @INSTALL@ -d [PREFIX]/man/man1;
  @INSTALL@ -m 0444 @objroot@/bin/onyx/man/man1/onyx.1 [PREFIX]/man/man1;

  @INSTALL@ -d [PREFIX]/share;
  rm -f [PREFIX]/share/onyx;
  ln -s onyx-@onyx_version@ [PREFIX]/share/onyx;
}

onyx_bins_uninstall :
{
  rm -f [PREFIX]/bin/onyx-@onyx_version@;
  rm -f [PREFIX]/bin/onyx;
  rm -f [PREFIX]/man/man1/onyx.1;
  rm -f [PREFIX]/share/onyx;
}

onyx_bins_clean :
{
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.d_a
                [ONYX_COMMON_SRCS] [BONYX_ONLY_SRCS] [TONYX_SRCS]];
  rm -f [fromto @srcroot@/%0%.c @objroot@/%0%.o_a
                [ONYX_COMMON_SRCS] [BONYX_ONLY_SRCS] [TONYX_SRCS]];

  rm -f [fromto @objroot@/%0%.c @objroot@/%0%.d_a [ONYX_ONLY_SRCS]];
  rm -f [fromto @objroot@/%0%.c @objroot@/%0%.o_a [ONYX_ONLY_SRCS]];

  rm -f [ONYX_ONLY_SRCS];

#if [count [ONYX_OTESTS]]
  rm -f [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx.out [ONYX_OTESTS]];
  rm -f [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx.diff [ONYX_OTESTS]];
  rm -f [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx [ONYX_OTESTS]];
#endif

#if [count [ONYX_BTESTS]]
  rm -f [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx [ONYX_BTESTS]];
#endif

  rm -f [ONYX] [BONYX] [TONYX];
}

onyx_bins_distclean :
{
  rm -f [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx.perf [ONYX_OTESTS]];

  rm -f [fromto @srcroot@/%0%.nx.in @objroot@/%0%.nx ONYX_NSRCS];
}

/*
 * Dependencies.
 */

[TONYX] : [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [TONYX_SRCS]]
#if @enable_modprompt@
          modprompt
#endif
  set mkdir
{
  [CC] [A_CFLAGS] -o [target]
       [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [TONYX_SRCS]];
}

[BONYX] : [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [ONYX_COMMON_SRCS]]
          [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [BONYX_ONLY_SRCS]]
          [LIBBONYX_A]
  set mkdir
{
  [CC] [A_CFLAGS] -o [target] [need] [LDFLAGS] @LIBS@;
}

[ONYX] : [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [ONYX_COMMON_SRCS]]
         [fromto @objroot@/%0%.c @objroot@/%0%.o_a [ONYX_ONLY_SRCS]]
         libonyx_libs_s
  set mkdir
{
  [CC] [A_CFLAGS] -o [target]
       [fromto @srcroot@/%0%.c @objroot@/%0%.o_a [ONYX_COMMON_SRCS]]
       [fromto @objroot@/%0%.c @objroot@/%0%.o_a [ONYX_ONLY_SRCS]]
#if [count @RPATH@]
       @RPATH@@abs_objroot@/lib/libonyx/lib
#endif
       [LDFLAGS] -lonyx @LIBS@;
}
